using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using MongoDB.Bson;
using MongoDB.Bson.Serialization.Attributes;
using MalwareHuntAgent.DataCapture;

namespace MalwareHuntAgent
{
    class Program
    {
        public static CancellationToken s_cancelToken = new CancellationToken();
        public const string DATA_DIR = @".\Data";
        public static string s_machineID;
        static void Main(string[] args)
        {
            if (Directory.Exists(DATA_DIR))
            {
                Directory.Delete(DATA_DIR, true);
            }
            Directory.CreateDirectory(DATA_DIR);

            if (File.Exists("machineid"))
            {
                s_machineID = File.ReadAllText("machineid");
            }
            else
            {
                s_machineID = ObjectId.GenerateNewId().ToString();
                File.WriteAllText("machineid", s_machineID);
            }

            //NetworkCapture.Capture();
            ModuleCapture.Instance.Start();
            FileCapture.Instance.Start();
            DataSender.Instance.Start();
            while (!s_cancelToken.IsCancellationRequested) { s_cancelToken.WaitHandle.WaitOne(5000); }
        }
    }
}
